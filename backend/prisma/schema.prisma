generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

//////////////////// ENUMS ////////////////////

enum Role {
  SUPER_ADMIN
  ADMIN
  OPS_MANAGER
  OPS_EXECUTIVE
  SALES
  FINANCE
  COMPLIANCE
  USER
  CHIEF_ADMIN
  SUB_ADMIN
}

enum CaseStatus {
  CREATED
  UNDER_REVIEW
  APPROVED
  PAYMENT_PENDING
  IN_PROGRESS
  RESOLVED
  CLOSED
}

enum IssueStatus {
  OPEN
  ASSIGNED
  IN_PROGRESS
  ESCALATED
  RESOLVED
  REJECTED
}

enum PaymentStatus {
  PENDING
  SUCCESS
  FAILED
  REFUNDED
}

enum AuditAction {
  LOGIN
  CREATE
  UPDATE
  DELETE
  ASSIGN
  STATUS_CHANGE
  PAYMENT
  EMAIL
  ESCALATE
  BULK_STATUS
}

enum EmailDirection {
  INBOUND
  OUTBOUND
}

enum LeadStatus {
  NEW
  QUOTATION
  SALES
  CLOSED
}

enum ApprovalStatus {
  PENDING
  APPROVED
  REJECTED
}

//////////////////// MODELS ////////////////////

model User {
  id        Int      @id @default(autoincrement())
  name      String
  phone     String   @unique
  password  String
  email     String   @unique
  role      Role     @default(USER)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())

  cases         Case[]
  audits        AuditLog[]
  creditReports CreditReport[]
  leads         Lead[]
}

//////////////////// CREDIT REPORT ////////////////////

model CreditReport {
  id        Int      @id @default(autoincrement())
  userId    Int
  bureau    String
  rawData   Json
  pdfUrl    String
  createdAt DateTime @default(now())

  user  User   @relation(fields: [userId], references: [id])
  cases Case[]
}

//////////////////// CASE ////////////////////

model Case {
  id        Int      @id @default(autoincrement())
  userId    Int
  reportId  Int
  status    CaseStatus
  createdAt DateTime @default(now())

  user    User         @relation(fields: [userId], references: [id])
  report  CreditReport @relation(fields: [reportId], references: [id])

  issues  Issue[]
  payment Payment?
}

//////////////////// ISSUE ////////////////////

model Issue {
  id          Int      @id @default(autoincrement())
  caseId      Int
  type        String
  bureau      String
  confidence  String
  explanation String
  status      IssueStatus
  assignedTo  String?
  createdAt   DateTime @default(now())

  case      Case       @relation(fields: [caseId], references: [id])
  emailLogs EmailLog[]
  documents Document[]
}

//////////////////// PAYMENT ////////////////////

model Payment {
  id           Int      @id @default(autoincrement())
  caseId       Int      @unique
  amount       Int
  status       PaymentStatus
  gatewayOrder String
  createdAt    DateTime @default(now())

  case Case @relation(fields: [caseId], references: [id])
}

//////////////////// AUDIT ////////////////////

model AuditLog {
  id        Int      @id @default(autoincrement())
  userId    Int?
  action    AuditAction
  entity    String
  entityId  String
  meta      Json
  createdAt DateTime @default(now())

  user User? @relation(fields: [userId], references: [id])
}

//////////////////// EMAIL ////////////////////

model EmailLog {
  id        Int      @id @default(autoincrement())
  issueId   Int
  subject   String
  body      String
  direction EmailDirection
  createdAt DateTime @default(now())

  issue Issue @relation(fields: [issueId], references: [id])
}

//////////////////// DOCUMENT ////////////////////

model Document {
  id             Int      @id @default(autoincrement())
  issueId        Int
  url            String
  uploadedByRole String
  version        Int      @default(1)
  createdAt      DateTime @default(now())

  issue Issue @relation(fields: [issueId], references: [id])
}

//////////////////// LEAD ////////////////////

model Lead {
  id          Int      @id @default(autoincrement())
  name        String
  contact     String
  city        String
  query       String
  status      LeadStatus @default(NEW)

  createdById Int

  createdBy   User @relation(fields: [createdById], references: [id])

  quotations  Quotation[]
  cases       Cases[]

  createdAt DateTime @default(now())
}

//////////////////// QUOTATION ////////////////////

model Quotation {
  id          Int      @id @default(autoincrement())
  leadId      Int
  amount      Float
  description String
  status      ApprovalStatus @default(PENDING)

  lead  Lead @relation(fields: [leadId], references: [id])
  sales Sale[]
  cases Cases[]

  createdAt DateTime @default(now())
}

//////////////////// SALE ////////////////////

model Sale {
  id          Int      @id @default(autoincrement())
  quotationId Int
  amount      Float

  quotation Quotation @relation(fields: [quotationId], references: [id])
  cases     Cases[]

  createdAt DateTime @default(now())
}

//////////////////// CASES (SALES FLOW) ////////////////////

model Cases {
  id          Int @id @default(autoincrement())

  leadId      Int
  quotationId Int
  saleId      Int

  lead      Lead      @relation(fields: [leadId], references: [id])
  quotation Quotation @relation(fields: [quotationId], references: [id])
  sale      Sale      @relation(fields: [saleId], references: [id])
}
